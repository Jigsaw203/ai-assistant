<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>AI助手管理系统</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background: #f5f7fa;
				color: #333;
			}

			.container {
				display: flex;
				min-height: 100vh;
			}

			/* 侧边栏 */
			.sidebar {
				width: 240px;
				background: white;
				box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
				padding: 20px 0;
			}

			.logo {
				display: flex;
				align-items: center;
				padding: 0 24px 30px;
				font-size: 18px;
				font-weight: bold;
				color: #4285f4;
			}

			.logo::before {
				content: "🤖";
				margin-right: 8px;
				font-size: 24px;
			}

			.nav-menu {
				list-style: none;
			}

			.nav-item {
				margin: 4px 12px;
			}

			.nav-link {
				display: flex;
				align-items: center;
				padding: 12px 16px;
				text-decoration: none;
				color: #666;
				border-radius: 8px;
				transition: all 0.3s ease;
			}

			.nav-link:hover,
			.nav-link.active {
				background: #e3f2fd;
				color: #4285f4;
			}

			.nav-icon {
				width: 20px;
				height: 20px;
				margin-right: 12px;
				font-size: 18px;
			}

			/* 主内容区域 */
			.main-content {
				flex: 1;
				padding: 24px;
			}

			/* 顶部栏 */
			.header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 24px;
			}

			.search-box {
				display: flex;
				align-items: center;
				background: white;
				border: 1px solid #e0e0e0;
				border-radius: 24px;
				padding: 8px 16px;
				width: 300px;
			}

			.search-box input {
				border: none;
				outline: none;
				margin-left: 8px;
				flex: 1;
			}

			.user-info {
				display: flex;
				align-items: center;
				gap: 16px;
			}

			.user-avatar {
				width: 32px;
				height: 32px;
				border-radius: 50%;
				background: #4285f4;
				display: flex;
				align-items: center;
				justify-content: center;
				color: white;
				font-weight: bold;
			}

			/* 工作台横幅 */
			.workspace-banner {
				/* 修改后的背景：使用图片 image_0c532c.png 作为背景 */
				background-image:
					/* linear-gradient(135deg, rgba(102, 126, 234, 0.6) 0%, rgba(118, 75, 162, 0.6) 100%), */
					url('bg-img.png');
				/* **重要：请确保这里的图片路径是正确的** */
				background-size: cover;
				/* 确保图片覆盖整个横幅区域 */
				background-position: center;
				/* 确保图片居中显示 */
				background-repeat: no-repeat;
				/* 不重复平铺 */

				border-radius: 16px;
				padding: 32px;
				color: white;
				margin-bottom: 24px;
				position: relative;
				overflow: hidden;
			}

			.banner-content h2 {
				font-size: 24px;
				margin-bottom: 8px;
			}

			.banner-content p {
				opacity: 0.9;
				margin-bottom: 20px;
			}

			.btn-primary {
				background: rgba(255, 255, 255, 0.2);
				border: 1px solid rgba(255, 255, 255, 0.3);
				color: white;
				padding: 10px 20px;
				border-radius: 8px;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.btn-primary:hover {
				background: rgba(255, 255, 255, 0.3);
			}

			/* 仪表盘上的新建任务按钮 */
			.btn-primary.new-task {
				background: #4285f4;
				padding: 6px 12px;
				border: none;
				/* 移除横幅按钮带的边框 */
			}

			.banner-illustration {
				position: absolute;
				right: 40px;
				top: 50%;
				transform: translateY(-50%);
				font-size: 120px;
				opacity: 0.7;
			}

			/* 统计卡片 */
			.stats-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 20px;
				margin-bottom: 24px;
			}

			.stat-card {
				background: white;
				border-radius: 12px;
				padding: 24px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
				position: relative;
				overflow: hidden;
			}

			.stat-icon {
				width: 48px;
				height: 48px;
				border-radius: 12px;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 24px;
				margin-bottom: 16px;
			}

			.stat-number {
				font-size: 28px;
				font-weight: bold;
				margin-bottom: 4px;
			}

			.stat-label {
				color: #666;
				font-size: 14px;
			}

			.blue {
				background: #e3f2fd;
				color: #1976d2;
			}

			.green {
				background: #e8f5e8;
				color: #388e3c;
			}

			.orange {
				background: #fff3e0;
				color: #f57c00;
			}

			.purple {
				background: #f3e5f5;
				color: #7b1fa2;
			}

			/* 主要内容区域 */
			.content-grid {
				display: grid;
				grid-template-columns: 2fr 1fr;
				gap: 24px;
			}

			.content-grid.two-cols {
				grid-template-columns: 1fr 1fr;
			}

			.content-section {
				background: white;
				border-radius: 12px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
			}

			.section-header {
				padding: 20px 24px;
				border-bottom: 1px solid #f0f0f0;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.section-title {
				font-size: 16px;
				font-weight: 600;
			}

			/* 图表区域 */
			.chart-container {
				padding: 24px;
				height: 300px;
				position: relative;
			}

			.chart-placeholder {
				width: 100%;
				height: 100%;
				background: linear-gradient(45deg, #f8f9fa, #e9ecef);
				border-radius: 8px;
				display: flex;
				align-items: center;
				justify-content: center;
				color: #666;
				font-size: 14px;
				flex-direction: column;
			}

			/* 任务队列 */
			.schedule-list {
				padding: 0 24px 24px;
			}

			.schedule-item {
				display: flex;
				align-items: center;
				padding: 12px 0;
				border-bottom: 1px solid #f5f5f5;
			}

			.schedule-item:last-child {
				border-bottom: none;
			}

			.schedule-time {
				width: 60px;
				font-size: 12px;
				color: #999;
			}

			.schedule-content {
				flex: 1;
				margin-left: 16px;
			}

			.schedule-title {
				font-size: 14px;
				font-weight: 500;
				margin-bottom: 2px;
			}

			.schedule-subtitle {
				font-size: 12px;
				color: #999;
			}

			.schedule-status {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				margin-right: 12px;
			}

			.status-waiting {
				background: #ffa726;
			}

			.status-running {
				background: #66bb6a;
			}

			.status-completed {
				background: #42a5f5;
			}

			.status-failed {
				background: #d32f2f;
			}

			/* 任务列表按钮样式 */
			.btn-task {
				padding: 4px 8px;
				border-radius: 8px;
				cursor: pointer;
				border: none;
				font-size: 12px;
				margin-left: 5px;
				transition: background 0.2s;
			}

			.btn-assign-auto {
				background: #e8f5e8;
				color: #388e3c;
			}

			.btn-multi-assign {
				background: #f3e5f5;
				color: #7b1fa2;
			}

			.btn-mark-complete {
				background: #e3f2fd;
				color: #1976d2;
			}

			.btn-mark-failed {
				background: #ffebee;
				color: #d32f2f;
			}

			/* 助手管理按钮样式 */
			.btn-assistant {
				padding: 6px 10px;
				margin-left: 5px;
				font-size: 12px;
			}

			.btn-start-service {
				background: #e8f5e8;
				color: #388e3c;
			}

			.btn-stop-service {
				background: #fff3e0;
				color: #f57c00;
			}

			.btn-edit-assistant {
				background: #e3f2fd;
				color: #1976d2;
			}

			.btn-delete-assistant {
				background: #ffebee;
				color: #d32f2f;
			}


			/* 模态框 */
			.modal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.5);
				z-index: 1000;
			}

			.modal-content {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: white;
				border-radius: 12px;
				width: 90%;
				max-width: 600px;
				max-height: 80vh;
				overflow-y: auto;
			}

			.modal-header {
				padding: 24px;
				border-bottom: 1px solid #f0f0f0;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.close-btn {
				background: none;
				border: none;
				font-size: 24px;
				cursor: pointer;
				color: #999;
			}

			.modal-body {
				padding: 24px;
			}

			.form-group {
				margin-bottom: 16px;
			}

			.form-group label {
				display: block;
				margin-bottom: 8px;
				font-weight: 500;
			}

			.form-group input,
			.form-group select,
			.form-group textarea {
				width: 100%;
				padding: 10px 12px;
				border: 1px solid #e0e0e0;
				border-radius: 8px;
				outline: none;
			}

			.form-group input:focus,
			.form-group select:focus,
			.form-group textarea:focus {
				border-color: #4285f4;
			}

			.checkbox-group {
				display: flex;
				align-items: center;
				margin-top: 10px;
			}

			.checkbox-group input[type="checkbox"] {
				width: auto;
				margin-right: 8px;
			}

			.btn-group {
				display: flex;
				gap: 12px;
				justify-content: flex-end;
				margin-top: 24px;
			}

			.btn {
				padding: 10px 20px;
				border-radius: 8px;
				cursor: pointer;
				border: none;
				font-size: 14px;
			}

			.btn-cancel {
				background: #f5f5f5;
				color: #666;
			}

			.btn-save {
				background: #4285f4;
				color: white;
			}

			/* 表格样式 */
			.table-container {
				padding: 24px;
				overflow-x: auto;
			}

			.table {
				width: 100%;
				border-collapse: collapse;
			}

			.table th,
			.table td {
				padding: 12px 16px;
				text-align: left;
				border-bottom: 1px solid #f0f0f0;
			}

			.table th {
				background: #f8f9fa;
				font-weight: 600;
				color: #666;
			}

			.status-badge {
				padding: 4px 8px;
				border-radius: 4px;
				font-size: 12px;
				font-weight: 500;
			}

			.status-online {
				background: #e8f5e8;
				color: #388e3c;
			}

			.status-offline {
				background: #ffebee;
				color: #d32f2f;
			}

			.status-waiting {
				background: #fff3e0;
				color: #f57c00;
			}

			.status-running {
				background: #e3f2fd;
				color: #1976d2;
			}

			.status-completed {
				background: #e8f5e8;
				color: #388e3c;
			}

			.status-failed {
				background: #ffebee;
				color: #d32f2f;
			}


			/* 响应式设计 */
			@media (max-width: 768px) {
				.container {
					flex-direction: column;
				}

				.sidebar {
					width: 100%;
					height: auto;
				}

				.content-grid {
					grid-template-columns: 1fr;
				}

				.stats-grid {
					grid-template-columns: repeat(2, 1fr);
				}

				#taskChart {
					max-height: 250px;
				}
			}
		</style>
	</head>
	<body>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
		<div class="container">
			<aside class="sidebar">
				<div class="logo">AI工作台</div>
				<nav>
					<ul class="nav-menu">
						<li class="nav-item">
							<a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">
								<span class="nav-icon"></span>
								数据中心
							</a>
						</li>
						<li class="nav-item">
							<a href="#assistants" class="nav-link" onclick="showSection('assistants')">
								<span class="nav-icon"></span>
								智能助手管理
							</a>
						</li>
						<li class="nav-item">
							<a href="#tasks" class="nav-link" onclick="showSection('tasks')">
								<span class="nav-icon"></span>
								任务管理
							</a>
						</li>
						<li class="nav-item">
							<a href="#logs" class="nav-link" onclick="showSection('logs')">
								<span class="nav-icon"></span>
								日志中心
							</a>
						</li>
						<li class="nav-item">
							<a href="#stats" class="nav-link" onclick="showSection('stats')">
								<span class="nav-icon"></span>
								统计中心
							</a>
						</li>
					</ul>
				</nav>
			</aside>

			<main class="main-content">
				<div id="dashboard-section" class="section">
					<div class="workspace-banner">
						<div class="banner-content">
							<h2>AI助手管理工作台</h2>
							<p>开启助手新体验，智能化您的管理工作流程</p>
							<button class="btn-primary" onclick="openAssistantModal()">立即开始</button>
						</div>
						<div class="banner-illustration">🚀</div>
					</div>

					<div class="stats-grid" id="dashboard-stats-grid">
						<div class="stat-card">
							<div class="stat-icon blue">🤖</div>
							<div class="stat-number" id="stat-assistant-count">--</div>
							<div class="stat-label">助手总数</div>
						</div>
						<div class="stat-card">
							<div class="stat-icon green">✅</div>
							<div class="stat-number" id="stat-completed-count">--</div>
							<div class="stat-label">已完成任务</div>
						</div>
						<div class="stat-card">
							<div class="stat-icon orange">⏳</div>
							<div class="stat-number" id="stat-running-count">--</div>
							<div class="stat-label">运行中任务</div>
						</div>
						<div class="stat-card">
							<div class="stat-icon purple">🔄</div>
							<div class="stat-number" id="stat-log-count">--</div>
							<div class="stat-label">总操作日志</div>
						</div>
					</div>

					<div class="content-grid">
						<div class="content-section">
							<div class="section-header">
								<div class="section-title">待处理任务队列</div>
								<button class="btn-primary new-task" onclick="openTaskModal()">+ 新建任务</button>
							</div>
							<div class="schedule-list" id="waiting-list">
								<div style="padding: 12px; color: #999; text-align: center;">正在加载待处理任务...</div>
							</div>
						</div>

						<div class="content-section">
							<div class="section-header">
								<div class="section-title">今日任务分布</div>
							</div>
							<div class="chart-container">
								<div class="chart-placeholder">
									<canvas id="taskChart"></canvas>
								</div>
							</div>
						</div>
					</div>

				</div>

				<div id="assistants-section" class="section" style="display: none;">
					<div class="content-section">
						<div class="section-header">
							<div class="section-title">智能助手管理</div>
							<button class="btn-primary" onclick="openAssistantModal()">+ 创建新助手</button>
						</div>
						<div class="table-container">
							<table class="table">
								<thead>
									<tr>
										<th>ID</th>
										<th>名称</th>
										<th>类型</th>
										<th>状态</th>
										<th>评分</th>
										<th>操作</th>
									</tr>
								</thead>
								<tbody id="assistants-table-body">
									<tr>
										<td colspan="6" style="text-align: center;">正在加载助手数据...</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<div id="tasks-section" class="section" style="display: none;">
					<div class="content-grid two-cols">
						<div class="content-section">
							<div class="section-header">
								<div class="section-title">运行中任务 (Running)</div>
							</div>
							<div class="schedule-list" id="running-list">
								<div style="padding: 12px; color: #999; text-align: center;">正在加载运行中任务...</div>
							</div>
						</div>

						<div class="content-section">
							<div class="section-header">
								<div class="section-title">已完成任务 (Completed)</div>
							</div>
							<div class="schedule-list" id="completed-list">
								<div style="padding: 12px; color: #999; text-align: center;">正在加载已完成任务...</div>
							</div>
						</div>
					</div>
				</div>

				<div id="logs-section" class="section" style="display: none;">
					<div class="content-section">
						<div class="section-header">
							<div class="section-title">操作日志中心</div>
						</div>
						<div class="table-container">
							<table class="table">
								<thead>
									<tr>
										<th>ID</th>
										<th>任务ID</th>
										<th>助手ID</th>
										<th>操作描述</th>
										<th>状态</th>
										<th>时间</th>
									</tr>
								</thead>
								<tbody id="logs-table-body">
									<tr>
										<td colspan="6" style="text-align: center;">正在加载日志数据...</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<div id="stats-section" class="section" style="display: none;">
					<div class="content-section">
						<div class="section-header">
							<div class="section-title">详细系统统计</div>
						</div>
						<div style="padding: 24px;">
							<div class="stats-grid">
								<div class="stat-card">
									<div class="stat-icon blue">🤖</div>
									<div class="stat-number" id="stats-total-assistants">--</div>
									<div class="stat-label">助手总数</div>
								</div>
								<div class="stat-card">
									<div class="stat-icon green">✅</div>
									<div class="stat-number" id="stats-online-assistants">--</div>
									<div class="stat-label">在线助手</div>
								</div>
								<div class="stat-card">
									<div class="stat-icon orange">❌</div>
									<div class="stat-number" id="stats-offline-assistants">--</div>
									<div class="stat-label">离线助手</div>
								</div>
								<div class="stat-card">
									<div class="stat-icon purple">⭐</div>
									<div class="stat-number" id="stats-avg-score">--</div>
									<div class="stat-label">平均评分</div>
								</div>
							</div>

							<div class="stats-grid" style="margin-top: 20px;">
								<div class="stat-card">
									<div class="stat-icon blue">📋</div>
									<div class="stat-number" id="stats-total-tasks">--</div>
									<div class="stat-label">任务总数</div>
								</div>
								<div class="stat-card">
									<div class="stat-icon green">✔️</div>
									<div class="stat-number" id="stats-completed-tasks">--</div>
									<div class="stat-label">已完成任务</div>
								</div>
								<div class="stat-card">
									<div class="stat-icon orange">⏳</div>
									<div class="stat-number" id="stats-running-tasks">--</div>
									<div class="stat-label">运行中任务</div>
								</div>
								<div class="stat-card">
									<div class="stat-icon purple">⌛</div>
									<div class="stat-number" id="stats-waiting-tasks">--</div>
									<div class="stat-label">等待中任务</div>
								</div>
							</div>

							<div class="content-section" style="margin-top: 24px; padding: 24px; text-align: center;">
								<h4 style="margin-bottom: 16px;">任务成功率</h4>
								<div style="font-size: 48px; font-weight: bold; color: #4285f4;"
									id="stats-success-rate">--</div>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>

		<div id="assistant-modal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3 id="assistant-modal-title">创建新助手</h3>
					<button class="close-btn" onclick="closeAssistantModal()">×</button>
				</div>
				<div class="modal-body">
					<form id="assistant-form">
						<div class="form-group">
							<label for="assistantName">助手名称</label>
							<input type="text" id="assistantName" name="assistantName" required>
						</div>
						<div class="form-group">
							<label for="assistantType">助手类型</label>
							<select id="assistantType" name="assistantType" required>
								<option value="文本生成">文本生成</option>
								<option value="图像处理">图像处理</option>
								<option value="数据分析">数据分析</option>
								<option value="语音识别">语音识别</option>
							</select>
						</div>
						<div class="form-group">
							<label for="assistantVersion">版本号</label>
							<input type="text" id="assistantVersion" name="assistantVersion" value="1.0" required>
						</div>
						<div class="form-group">
							<label for="assistantScore">能力评分 (0-100)</label>
							<input type="number" id="assistantScore" name="assistantScore" min="0" max="100" value="80"
								required>
						</div>
						<div class="form-group checkbox-group">
							<input type="checkbox" id="assistantOnline" name="assistantOnline">
							<label for="assistantOnline" style="margin-bottom: 0;">是否在线</label>
						</div>
						<div class="btn-group">
							<button type="button" class="btn btn-cancel" onclick="closeAssistantModal()">取消</button>
							<button type="submit" class="btn btn-save">保存</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div id="task-modal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>创建新任务</h3>
					<button class="close-btn" onclick="closeTaskModal()">×</button>
				</div>
				<div class="modal-body">
					<form id="task-form">
						<div class="form-group">
							<label for="taskType">任务类型</label>
							<select id="taskType" name="taskType" required>
								<option value="">请选择任务类型</option>
								<option value="文本生成">文本生成</option>
								<option value="图像处理">图像处理</option>
								<option value="数据分析">数据分析</option>
								<option value="语音识别">语音识别</option>
							</select>
						</div>
						<div class="form-group">
							<label for="taskContent">任务内容</label>
							<textarea id="taskContent" name="taskContent" rows="5" placeholder="请输入任务的具体描述..."
								required></textarea>
						</div>
						<div class="btn-group">
							<button type="button" class="btn btn-cancel" onclick="closeTaskModal()">取消</button>
							<button type="submit" class="btn btn-save">提交任务</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div id="multi-assign-modal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>多助手协作分配</h3>
					<button class="close-btn" onclick="closeMultiAssignModal()">×</button>
				</div>
				<div class="modal-body">
					<form id="multi-assign-form">
						<div class="form-group">
							<label>选择协作助手 (可多选)</label>
							<div id="assistant-checkbox-list"
								style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px;">
								<p style="color: #999; text-align: center;">正在加载助手列表...</p>
							</div>
						</div>
						<div class="btn-group">
							<button type="button" class="btn btn-cancel" onclick="closeMultiAssignModal()">取消</button>
							<button type="submit" class="btn btn-save">确认分配</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<script>
			// 后端 API 基础 URL (已更新为指定的后端端口)
			const BASE_URL = 'http://localhost:8080/api';

			// 当前编辑的助手ID,用于区分新增和编辑
			let currentAssistantId = null;

			// 当前进行多助手协作分配的任务ID
			let currentTaskIdForMultiAssign = null;

			// Chart.js 实例
			let taskChartInstance = null;

			// --- 通用 API 工具函数 ---

			/**
			 * 统一处理前后端数据交互
			 * @param {string} endpoint - API 路径,例如 '/stats' 或 '/assistant/1'
			 * @param {string} [method='GET'] - HTTP 方法
			 * @param {object} [data=null] - 要发送的请求体数据
			 */
			async function fetchData(endpoint, method = 'GET', data = null) {
				const url = `${BASE_URL}${endpoint}`;
				const options = {
					method: method,
					headers: {
						'Content-Type': 'application/json',
					},
				};

				if (data && (method === 'POST' || method === 'PUT')) {
					options.body = JSON.stringify(data);
				}

				try {
					const response = await fetch(url, options);

					if (!response.ok) {
						const errorText = await response.text();
						const errorMessage = errorText.length < 500 ? errorText : response.statusText;
						throw new Error(`API 请求失败 (${response.status}): ${errorMessage}`);
					}

					if (response.status === 204 || (response.headers.get('content-length') === '0' && response.status !==
							200)) {
						return null;
					}

					return await response.json();
				} catch (error) {
					console.error(`请求 ${method} ${url} 失败:`, error);
					// 使用更友好的方式提醒用户
					alert('操作失败或后端服务不可用,请检查控制台和网络连接。错误: ' + error.message);
					throw error;
				}
			}

			// --- 视图切换和初始化 ---

			/**
			 * 切换页面视图,并根据视图加载数据
			 */
			function showSection(sectionId) {
				document.querySelectorAll('.section').forEach(section => {
					section.style.display = 'none';
				});
				document.getElementById(`${sectionId}-section`).style.display = 'block';

				// 激活侧边栏链接
				document.querySelectorAll('.nav-link').forEach(link => {
					link.classList.remove('active');
					if (link.getAttribute('href') === `#${sectionId}`) {
						link.classList.add('active');
					}
				});

				// 切换视图时加载数据
				switch (sectionId) {
					case 'dashboard':
						fetchStats();
						fetchTasks(); // 加载待处理任务
						break;
					case 'stats':
						loadDetailedStats();
						break;
					case 'assistants':
						fetchAssistants();
						break;
					case 'tasks':
						fetchTasks();
						break;
					case 'logs':
						fetchLogs();
						break;
				}
			}

			// --- 统计数据 (StatsController) ---

			const statAssistantCount = document.getElementById('stat-assistant-count');
			const statCompletedCount = document.getElementById('stat-completed-count');
			const statRunningCount = document.getElementById('stat-running-count');
			const statLogCount = document.getElementById('stat-log-count');

			async function fetchStats() {
				try {
					// API: GET http://localhost:8080/api/stats
					const stats = await fetchData('/stats');
					if (!stats) return;

					// 根据后端StatsService.java返回的字段名映射
					statAssistantCount.textContent = stats.totalAssistants ?? '0';
					statCompletedCount.textContent = stats.completedTasks ?? '0';
					statRunningCount.textContent = stats.runningTasks ?? '0';

					// 日志总数需要单独获取
					fetchLogCount();

					// 更新图表数据
					updateTaskChart(stats);

				} catch (error) {
					// 错误已在 fetchData 中处理
				}
			}

			/**
			 * 更新任务分布图表
			 */
			function updateTaskChart(stats) {
				const ctx = document.getElementById('taskChart');
				if (!ctx) return;

				if (taskChartInstance) {
					taskChartInstance.destroy();
				}

				const total = (stats.waitingTasks ?? 0) + (stats.runningTasks ?? 0) +
					(stats.completedTasks ?? 0) + (stats.failedTasks ?? 0);

				// 根据图片中的颜色和任务状态映射关系进行修改:
				// 任务状态顺序: ['等待中', '运行中', '已完成', '失败']
				// 对应颜色顺序: [采购成本(灰), 推广费(橙), 发货费(蓝), 促销费(绿)]
				const BACKGROUND_COLORS = [
					'#6c757d', // 灰 (等待中)
					'#6dca37', // 橙 (运行中)
					'#007bff', // 蓝 (已完成)
					'#ff4040' // 红 (失败)
				];

				const chartData = {
					labels: ['等待中', '运行中', '已完成', '失败'],
					datasets: [{
						data: [
							stats.waitingTasks ?? 0,
							stats.runningTasks ?? 0,
							stats.completedTasks ?? 0,
							stats.failedTasks ?? 0
						],
						// 使用图片中的纯色替代原来的渐变色
						backgroundColor: BACKGROUND_COLORS,
						borderWidth: 2
					}]
				};

				taskChartInstance = new Chart(ctx, {
					type: 'doughnut',
					data: chartData,
					options: {
						responsive: true,
						maintainAspectRatio: false,
						cutout: '70%', // 环形宽度
						plugins: {
							legend: {
								position: 'bottom',
								labels: {
									usePointStyle: true,
									pointStyle: 'circle',
									padding: 20,
									font: {
										size: 13
									}
								}
							},
							tooltip: {
								backgroundColor: 'rgba(50,50,50,0.8)',
								titleColor: '#fff',
								bodyColor: '#fff',
								bodyFont: {
									weight: 'bold'
								},
								callbacks: {
									label: function(context) {
										const value = context.parsed;
										const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
										return `${context.label}: ${value} (${percentage}%)`;
									}
								}
							},
							// 在圆心显示总数
							beforeDraw: chart => {
								const {
									width
								} = chart;
								const {
									height
								} = chart;
								const ctx = chart.ctx;
								ctx.restore();
								ctx.font = "bold 18px Segoe UI";
								ctx.fillStyle = "#4285f4";
								ctx.textAlign = "center";
								ctx.textBaseline = "middle";
								ctx.fillText(`总数 ${total}`, width / 2, height / 2);
								ctx.save();
							}
						}
					}
				});
			}



			/**
			 * 获取日志总数
			 */
			async function fetchLogCount() {
				try {
					const logs = await fetchData('/log');
					statLogCount.textContent = (logs || []).length;
				} catch (error) {
					statLogCount.textContent = '0';
				}
			}

			/**
			 * 加载详细统计数据到统计中心页面
			 */
			async function loadDetailedStats() {
				try {
					const stats = await fetchData('/stats');
					if (!stats) return;

					// 助手统计
					document.getElementById('stats-total-assistants').textContent = stats.totalAssistants ?? '0';
					document.getElementById('stats-online-assistants').textContent = stats.onlineAssistants ?? '0';
					document.getElementById('stats-offline-assistants').textContent = stats.offlineAssistants ?? '0';
					document.getElementById('stats-avg-score').textContent = stats.averageScore ?? '0.00';

					// 任务统计
					document.getElementById('stats-total-tasks').textContent = stats.totalTasks ?? '0';
					document.getElementById('stats-completed-tasks').textContent = stats.completedTasks ?? '0';
					document.getElementById('stats-running-tasks').textContent = stats.runningTasks ?? '0';
					document.getElementById('stats-waiting-tasks').textContent = stats.waitingTasks ?? '0';

					// 成功率
					document.getElementById('stats-success-rate').textContent = stats.taskSuccessRate ?? '0.00%';

				} catch (error) {
					console.error('加载详细统计数据失败:', error);
				}
			}

			// --- 智能助手管理 (AssistantController) ---

			const assistantsTableBody = document.getElementById('assistants-table-body');

			async function fetchAssistants() {
				try {
					// API: GET http://localhost:8080/api/assistant
					const assistants = await fetchData('/assistant');
					renderAssistants(assistants || []);
				} catch (error) {}
			}

			function renderAssistants(assistants) {
				assistantsTableBody.innerHTML = ''; // 清空现有数据

				if (assistants.length === 0) {
					assistantsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无助手数据</td></tr>';
					return;
				}

				assistants.forEach(assistant => {
					// 后端 Assistant.java 中 online 是 Boolean 类型
					const statusClass = assistant.online ? 'status-online' : 'status-offline';
					const statusText = assistant.online ? '在线' : '离线';

					// 添加启动/停止服务按钮
					const serviceButton = assistant.online ?
						`<button onclick="stopAssistantService(${assistant.id})" class="btn btn-assistant btn-stop-service">停止服务</button>` :
						`<button onclick="startAssistantService(${assistant.id})" class="btn btn-assistant btn-start-service">启动服务</button>`;

					const row = `
                                    <tr>
                                        <td>${assistant.id}</td>
                                        <td>${assistant.name}</td>
                                        <td>${assistant.type}</td>
                                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                        <td>${assistant.score}</td>
                                        <td>
                                            ${serviceButton}
                                            <button onclick="editAssistant(${assistant.id})" class="btn btn-assistant btn-edit-assistant">编辑</button>
                                            <button onclick="deleteAssistant(${assistant.id})" class="btn btn-assistant btn-delete-assistant">删除</button>
                                        </td>
                                    </tr>
                                `;
					assistantsTableBody.insertAdjacentHTML('beforeend', row);
				});
			}

			const assistantModal = document.getElementById('assistant-modal');
			const assistantModalTitle = document.getElementById('assistant-modal-title');
			const assistantForm = document.getElementById('assistant-form');
			const assistantNameInput = document.getElementById('assistantName');
			const assistantTypeInput = document.getElementById('assistantType');
			const assistantVersionInput = document.getElementById('assistantVersion');
			const assistantScoreInput = document.getElementById('assistantScore');
			const assistantOnlineCheckbox = document.getElementById('assistantOnline');

			function openAssistantModal(assistant = null) {
				if (assistant) {
					// 编辑模式
					assistantModalTitle.textContent = '编辑智能助手';
					currentAssistantId = assistant.id;
					assistantNameInput.value = assistant.name;
					assistantTypeInput.value = assistant.type;
					assistantVersionInput.value = assistant.version || '';
					assistantOnlineCheckbox.checked = !!assistant.online; // 确保是布尔值
					assistantScoreInput.value = assistant.score || 0;
				} else {
					// 新增模式
					assistantModalTitle.textContent = '创建新助手';
					currentAssistantId = null;
					assistantForm.reset();
					assistantOnlineCheckbox.checked = true; // 新建时默认在线
				}
				assistantModal.style.display = 'block';
			}

			function closeAssistantModal() {
				assistantModal.style.display = 'none';
				currentAssistantId = null;
			}

			async function editAssistant(id) {
				try {
					// API: GET http://localhost:8080/api/assistant/{id}
					const assistant = await fetchData(`/assistant/${id}`);
					if (assistant) {
						openAssistantModal(assistant);
					}
				} catch (error) {}
			}

			assistantForm.addEventListener('submit', async function(e) {
				e.preventDefault();

				const form = e.target;
				const assistantData = {
					// ID 由后端自动生成,但编辑时需要传回
					id: currentAssistantId,
					name: form.assistantName.value,
					type: form.assistantType.value,
					version: form.assistantVersion.value,
					online: form.assistantOnline.checked, // 发送布尔值
					score: parseInt(form.assistantScore.value, 10) || 0
				};

				try {
					if (currentAssistantId) {
						// API: PUT http://localhost:8080/api/assistant/{id}
						await fetchData(`/assistant/${currentAssistantId}`, 'PUT', assistantData);
						alert('助手更新成功!');
					} else {
						// API: POST http://localhost:8080/api/assistant
						await fetchData('/assistant', 'POST', assistantData);
						alert('助手创建成功!');
					}
					closeAssistantModal();
					fetchAssistants(); // 刷新列表
				} catch (error) {}
			});

			async function deleteAssistant(id) {
				if (!confirm('确定要删除该助手吗?此操作不可逆!')) return;

				try {
					// API: DELETE http://localhost:8080/api/assistant/{id}
					await fetchData(`/assistant/${id}`, 'DELETE');
					alert('助手删除成功!');
					fetchAssistants(); // 刷新列表
				} catch (error) {}
			}

			/**
			 * 启动AI助手服务
			 */
			async function startAssistantService(id) {
				try {
					// API: PUT http://localhost:8080/api/assistant/{id}/start
					const assistant = await fetchData(`/assistant/${id}/start`, 'PUT');
					alert(`助手 ${assistant.name} 已启动服务,当前状态: 在线`);
					fetchAssistants(); // 刷新列表
				} catch (error) {}
			}

			/**
			 * 停止AI助手服务
			 */
			async function stopAssistantService(id) {
				try {
					// API: PUT http://localhost:8080/api/assistant/{id}/stop
					const assistant = await fetchData(`/assistant/${id}/stop`, 'PUT');
					alert(`助手 ${assistant.name} 已停止服务,当前状态: 离线`);
					fetchAssistants(); // 刷新列表
				} catch (error) {}
			}

			// --- 任务队列管理 (TaskQueueController & TaskAssignmentController) ---

			const waitingList = document.getElementById('waiting-list');
			const runningList = document.getElementById('running-list');
			const completedList = document.getElementById('completed-list');

			async function fetchTasks() {
				try {
					// API: GET http://localhost:8080/api/task/queue
					// 后端返回格式: { "waiting": [Task...], "running": [Task...], "completed": [Task...] }
					const tasksByStatus = await fetchData('/task/queue');

					if (!tasksByStatus) {
						renderTasks('waiting', []);
						renderTasks('running', []);
						renderTasks('completed', []);
						return;
					}

					renderTasks('waiting', tasksByStatus.waiting || []);
					renderTasks('running', tasksByStatus.running || []);
					renderTasks('completed', tasksByStatus.completed || []);

				} catch (error) {}
			}

			function renderTasks(statusKey, tasks) {
				const listElement = document.getElementById(`${statusKey}-list`);
				if (!listElement) return;

				listElement.innerHTML = ''; // 清空现有数据

				if (tasks.length === 0) {
					listElement.innerHTML =
						`<div style="padding: 12px; color: #999; text-align: center;">暂无 ${statusKey} 任务</div>`;
					return;
				}

				const statusMap = {
					'waiting': {
						class: 'status-waiting',
						text: '等待中'
					},
					'running': {
						class: 'status-running',
						text: '执行中'
					},
					'completed': {
						class: 'status-completed',
						text: '已完成'
					},
					'failed': {
						class: 'status-failed',
						text: '失败'
					}
				};

				tasks.forEach(task => {
					// TaskQueue.java 中 status 是 String
					const statusInfo = statusMap[task.status] || {
						class: 'status-waiting',
						text: '未知状态'
					};
					// 后端返回的是 ISO 格式的 createTime 字符串
					const timeDisplay = task.createTime ? new Date(task.createTime).toLocaleTimeString('zh-CN', {
						hour: '2-digit',
						minute: '2-digit'
					}) : 'N/A';

					// 任务操作按钮
					let actions = '';
					if (task.status === 'waiting') {
						// 自动分配按钮和多助手协作按钮
						actions = `
                                        <button onclick="assignTaskAuto(${task.id})" class="btn-task btn-assign-auto">自动分配</button>
                                        <button onclick="openMultiAssignModal(${task.id})" class="btn-task btn-multi-assign">多助手协作</button>
                                    `;
					} else if (task.status === 'running') {
						// 标记完成和标记失败按钮
						actions = `
                                        <button onclick="updateTaskStatus(${task.id}, 'completed')" class="btn-task btn-mark-complete">标记完成</button>
                                        <button onclick="updateTaskStatus(${task.id}, 'failed')" class="btn-task btn-mark-failed">标记失败</button>
                                    `;
					}

					const item = `
                                    <div class="schedule-item">
                                        <div class="schedule-status ${statusInfo.class}"></div>
                                        <div class="schedule-time">${timeDisplay}</div>
                                        <div class="schedule-content">
                                            <div class="schedule-title">${task.content.substring(0, 50)}${task.content.length > 50 ? '...' : ''}</div>
                                            <div class="schedule-subtitle">分配给: ${task.assignedTo || '未分配'}</div>
                                        </div>
                                        <div class="schedule-actions">${actions}</div>
                                    </div>
                                `;
					listElement.insertAdjacentHTML('beforeend', item);
				});
			}

			const taskModal = document.getElementById('task-modal');
			const taskForm = document.getElementById('task-form');

			function openTaskModal() {
				taskForm.reset();
				taskModal.style.display = 'block';
			}

			function closeTaskModal() {
				taskModal.style.display = 'none';
			}

			taskForm.addEventListener('submit', async function(e) {
				e.preventDefault();

				const form = e.target;
				const taskData = {
					type: form.taskType.value, // 新增任务类型字段
					content: form.taskContent.value
				};

				try {
					// API: POST http://localhost:8080/api/task (由 TaskQueueController 处理)
					await fetchData('/task', 'POST', taskData);
					alert('任务提交成功,等待分配。');
					closeTaskModal();
					// 刷新仪表盘和任务视图
					if (document.getElementById('dashboard-section').style.display !== 'none' ||
						document.getElementById('tasks-section').style.display !== 'none') {
						fetchTasks();
					}
				} catch (error) {}
			});

			/**
			 * 调用后端自动分配任务接口
			 */
			async function assignTaskAuto(taskId) {
				try {
					// API: POST http://localhost:8080/api/assign/auto/{taskId} (由 TaskAssignmentController 处理)
					const updatedTask = await fetchData(`/assign/auto/${taskId}`, 'POST');
					alert(`任务 ${taskId} 已自动分配给 ${updatedTask.assignedTo || '助手'},状态更新为运行中!`);
					fetchTasks(); // 刷新任务列表
				} catch (error) {}
			}

			/**
			 * 更新任务状态
			 */
			async function updateTaskStatus(taskId, newStatus) {
				try {
					// API: PUT http://localhost:8080/api/task/{id}/status?status={newStatus} (由 TaskQueueController 处理)
					await fetchData(`/task/${taskId}/status?status=${newStatus}`, 'PUT');
					alert(`任务 ${taskId} 状态已更新为 ${newStatus}!`);
					fetchTasks(); // 刷新任务列表
				} catch (error) {}
			}

			// --- 多助手协作功能 ---

			const multiAssignModal = document.getElementById('multi-assign-modal');
			const assistantCheckboxList = document.getElementById('assistant-checkbox-list');
			const multiAssignForm = document.getElementById('multi-assign-form');

			/**
			 * 打开多助手协作分配模态框
			 */
			async function openMultiAssignModal(taskId) {
				currentTaskIdForMultiAssign = taskId;
				multiAssignModal.style.display = 'block';

				try {
					// 获取所有在线助手
					const assistants = await fetchData('/assistant');
					const onlineAssistants = (assistants || []).filter(a => a.online);

					if (onlineAssistants.length === 0) {
						assistantCheckboxList.innerHTML = '<p style="color: #999; text-align: center;">暂无在线助手可供选择</p>';
						return;
					}

					// 渲染助手复选框列表
					assistantCheckboxList.innerHTML = '';
					onlineAssistants.forEach(assistant => {
						const item = `
                                        <div class="checkbox-group" style="margin-bottom: 12px; padding: 8px; border: 1px solid #f0f0f0; border-radius: 6px;">
                                            <input type="checkbox" id="assistant-${assistant.id}" value="${assistant.id}">
                                            <label for="assistant-${assistant.id}" style="margin-bottom: 0; cursor: pointer; flex: 1;">
                                                ${assistant.name} (${assistant.type}) - 评分: ${assistant.score}
                                            </label>
                                        </div>
                                    `;
						assistantCheckboxList.insertAdjacentHTML('beforeend', item);
					});
				} catch (error) {
					assistantCheckboxList.innerHTML = '<p style="color: #d32f2f; text-align: center;">加载助手列表失败</p>';
				}
			}

			/**
			 * 关闭多助手协作模态框
			 */
			function closeMultiAssignModal() {
				multiAssignModal.style.display = 'none';
				currentTaskIdForMultiAssign = null;
			}

			/**
			 * 提交多助手协作分配
			 */
			multiAssignForm.addEventListener('submit', async function(e) {
				e.preventDefault();

				// 获取所有选中的助手ID
				const checkboxes = document.querySelectorAll(
					'#assistant-checkbox-list input[type="checkbox"]:checked');
				const assistantIds = Array.from(checkboxes).map(cb => parseInt(cb.value, 10));

				if (assistantIds.length === 0) {
					alert('请至少选择一个助手进行协作!');
					return;
				}

				try {
					// API: POST http://localhost:8080/api/assign/multi/{taskId}
					// 注意: 后端要求将 assistantIds 数组作为请求体发送
					await fetchData(`/assign/multi/${currentTaskIdForMultiAssign}`, 'POST', assistantIds);
					alert(`任务已成功分配给 ${assistantIds.length} 个助手协作处理!`);
					closeMultiAssignModal();
					fetchTasks(); // 刷新任务列表
				} catch (error) {}
			});

			// --- 日志中心 (LogController) ---

			const logsTableBody = document.getElementById('logs-table-body');

			async function fetchLogs() {
				try {
					// API: GET http://localhost:8080/api/log
					const logs = await fetchData('/log');
					renderLogs(logs || []);
				} catch (error) {}
			}

			function renderLogs(logs) {
				logsTableBody.innerHTML = ''; // 清空现有数据

				if (logs.length === 0) {
					logsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无操作日志</td></tr>';
					return;
				}

				logs.forEach(log => {
					// Log.java 中 status 是 String
					const statusClass = log.status === '成功' ? 'status-completed' : 'status-failed';
					const timeDisplay = log.createTime ? new Date(log.createTime).toLocaleString('zh-CN', {
						hour12: false
					}) : 'N/A';

					const row = `
                                    <tr>
                                        <td>${log.id}</td>
                                        <td>${log.taskId || 'N/A'}</td>
                                        <td>${log.assistantId || 'N/A'}</td>
                                        <td>${log.action}</td>
                                        <td><span class="status-badge ${statusClass}">${log.status}</span></td>
                                        <td>${timeDisplay}</td>
                                    </tr>
                                `;
					logsTableBody.insertAdjacentHTML('beforeend', row);
				});
			}

			// --- 页面加载完成后初始化 ---
			document.addEventListener('DOMContentLoaded', function() {
				// 默认显示仪表盘
				showSection('dashboard');
			});
		</script>
	</body>
</html>